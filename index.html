// 国保法 条文ビューア（左：全文固定 / 右：条文ジャンプ対応 / 複数法律拡張前提）

import React, { useState } from "react";

// ===== 設計方針 =====
// ・pdf.js 不使用（環境依存回避）
// ・ブラウザ標準PDF Viewer 使用
// ・#page= でページジャンプ制御

export default function KokuhouLawViewer() {

  const [pdfUrl, setPdfUrl] = useState(null);
  const [fileName, setFileName] = useState("");
  const [error, setError] = useState(null);

  const [jumpPage, setJumpPage] = useState("");
  const [rightPdfUrl, setRightPdfUrl] = useState(null);

  // ===== PDF読み込み =====
  const handleFile = async (file) => {
    if (!file) return;

    try {
      setError(null);

      if (file.type !== "application/pdf") {
        throw new Error("PDFファイルを選択してください");
      }

      const url = URL.createObjectURL(file);

      setPdfUrl(url);
      setRightPdfUrl(url);
      setFileName(file.name);

    } catch (e) {
      console.error("PDF LOAD ERROR:", e);
      setError(e?.message || "PDF読み込みエラー");
    }
  };

  // ===== 条文ジャンプ =====
  const handleJump = () => {
    if (!pdfUrl) return;

    const page = Number(jumpPage);

    if (!page || page <= 0) {
      setError("正しいページ番号を入力してください");
      return;
    }

    setError(null);
    setRightPdfUrl(`${pdfUrl}#page=${page}`);
  };

  return (
    <div className="flex h-screen bg-gray-100">

      {/* ===== 左ペイン：全文固定 ===== */}
      <div className="w-1/2 bg-white border-r flex flex-col">

        <div className="p-4 border-b font-bold text-lg">
          全文表示
        </div>

        <div className="flex-1 bg-gray-200">
          {pdfUrl ? (
            <iframe
              src={pdfUrl}
              title="Full PDF Viewer"
              className="w-full h-full"
            />
          ) : (
            <div className="h-full flex items-center justify-center text-gray-600">
              PDFを選択してください
            </div>
          )}
        </div>

      </div>

      {/* ===== 右ペイン：条文ジャンプ ===== */}
      <div className="w-1/2 flex flex-col">

        <div className="p-3 bg-white border-b flex gap-3 items-center">

          <input
            type="file"
            accept="application/pdf"
            onChange={(e) => handleFile(e.target.files[0])}
          />

          <input
            type="number"
            placeholder="ページ番号"
            value={jumpPage}
            onChange={(e) => setJumpPage(e.target.value)}
            className="border px-2 py-1 rounded w-32"
          />

          <button
            onClick={handleJump}
            className="bg-blue-600 text-white px-3 py-1 rounded"
          >
            ジャンプ
          </button>

          {fileName && (
            <span className="text-sm text-gray-600 truncate max-w-xs">
              {fileName}
            </span>
          )}

          {error && <span className="text-red-500 text-sm">{error}</span>}

        </div>

        <div className="flex-1 bg-gray-300">
          {rightPdfUrl ? (
            <iframe
              src={rightPdfUrl}
              title="Jump PDF Viewer"
              className="w-full h-full"
            />
          ) : (
            <div className="h-full flex items-center justify-center text-gray-600">
              ページジャンプ先がここに表示されます
            </div>
          )}
        </div>

      </div>

    </div>
  );
}

// ===== 今後拡張しやすいポイント =====
// ・法律切替セレクタ追加可能
// ・条文JSON検索追加可能
// ・ブックマーク保存追加可能
// ・iPad UI最適化対応可能

// ===== テストケース =====
// 1. PDF読込 → 左に全文表示
// 2. ページ番号入力 → 右に該当ページ表示
// 3. 不正ページ → エラー表示
// 4. PDF再読込 → 両ペイン更新
// 5. 連続ジャンプ → 正常表示
