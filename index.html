// 国保法 条文ビューア（左：全文固定 / 右：条文ジャンプ対応 / PDF解析進捗可視化）

import React, { useState } from "react";

export default function LawViewer() {

  const [pdfUrl, setPdfUrl] = useState(null);
  const [fileName, setFileName] = useState("");
  const [error, setError] = useState(null);
  const [jumpPage, setJumpPage] = useState("");
  const [rightPdfUrl, setRightPdfUrl] = useState(null);

  // 進捗表示（疑似）
  const [progress, setProgress] = useState(0);
  const [isGenerating, setIsGenerating] = useState(false);

  // ===== PDF読み込み =====
  const handleFile = async (file) => {
    if (!file) return;

    try {
      setError(null);

      if (file.type !== "application/pdf") {
        throw new Error("PDFファイルを選択してください");
      }

      const url = URL.createObjectURL(file);

      setPdfUrl(url);
      setRightPdfUrl(url);
      setFileName(file.name);

      // 疑似進捗
      setIsGenerating(true);
      setProgress(0);

      let p = 0;
      const timer = setInterval(() => {
        p += 10;
        setProgress(p);
        if (p >= 100) {
          clearInterval(timer);
          setIsGenerating(false);
        }
      }, 200);

    } catch (e) {
      console.error("PDF LOAD ERROR:", e);
      setError(e?.message || "PDF読み込みエラー");
    }
  };

  // ===== ページジャンプ =====
  const handleJump = () => {
    if (!pdfUrl) return;

    const page = Number(jumpPage);

    if (!page || page <= 0) {
      setError("正しいページ番号を入力してください");
      return;
    }

    setError(null);

    const newUrl = `${pdfUrl}#page=${page}`;

    // 再描画トリガ
    setRightPdfUrl(null);
    setTimeout(() => setRightPdfUrl(newUrl), 50);
  };

  return (
    <div className="flex flex-col h-screen">

      {/* ===== 上部バー ===== */}
      <div className="p-3 border-b bg-white flex flex-wrap gap-3 items-center">

        <input
          type="file"
          accept="application/pdf"
          onChange={(e) => handleFile(e.target.files?.[0])}
        />

        {fileName && (
          <span className="text-sm text-gray-600">
            読込中: {fileName}
          </span>
        )}

        <div className="flex gap-2 items-center">
          <span>ページジャンプ:</span>
          <input
            className="border px-2 py-1 w-24"
            value={jumpPage}
            onChange={(e) => setJumpPage(e.target.value)}
            placeholder="例: 41"
          />
          <button
            onClick={handleJump}
            className="px-3 py-1 bg-blue-600 text-white rounded"
          >
            ジャンプ
          </button>
        </div>

        {error && (
          <span className="text-red-500 text-sm">{error}</span>
        )}

      </div>

      {/* ===== 進捗 ===== */}
      {isGenerating && (
        <div className="px-4 py-2 text-sm bg-yellow-50 border-b">
          条番号対応表 生成中… {progress}%
        </div>
      )}

      {/* ===== 本体 ===== */}
      <div className="flex flex-1 overflow-hidden">

        {/* ===== 左：全文 ===== */}
        <div className="w-1/2 border-r">
          {pdfUrl ? (
            <iframe
              title="full-pdf"
              src={pdfUrl}
              className="w-full h-full"
            />
          ) : (
            <div className="h-full flex items-center justify-center text-gray-500">
              PDFを読み込んでください
            </div>
          )}
        </div>

        {/* ===== 右：ジャンプ表示 ===== */}
        <div className="w-1/2">
          {rightPdfUrl ? (
            <iframe
              title="jump-pdf"
              src={rightPdfUrl}
              className="w-full h-full"
            />
          ) : (
            <div className="h-full flex items-center justify-center text-gray-500">
              ジャンプ先がここに表示されます
            </div>
          )}
        </div>

      </div>

    </div>
  );
}


// ===== テストケース =====
// 1. PDF読込 → 左右にPDF表示
// 2. ページ入力 → 右だけジャンプ
// 3. PDF未読込 → エラーなし
// 4. PDF以外 → エラー表示
// 5. 連続読込 → 正常切替
