// 国保法 条文ビューア（左：全文固定 / 右：条文ジャンプ対応 / PDF解析進捗可視化）
// ===== 設計方針 =====
// ・pdf.js 不使用（環境依存回避）
// ・ブラウザ標準PDF Viewer 使用
// ・#page= でページジャンプ制御
// ・将来：複数法律対応可能な構造

import React, { useState } from "react";

export default function LawViewer() {
  const [pdfUrl, setPdfUrl] = useState(null);
  const [fileName, setFileName] = useState("");
  const [error, setError] = useState(null);
  const [jumpPage, setJumpPage] = useState("");
  const [rightPdfUrl, setRightPdfUrl] = useState(null);

  // 自動生成進捗（疑似：将来PDF解析に置換）
  const [progress, setProgress] = useState(0);
  const [isGenerating, setIsGenerating] = useState(false);

  // ===== PDF読み込み =====
  const handleFile = async (file) => {
    if (!file) return;

    try {
      setError(null);

      if (file.type !== "application/pdf") {
        throw new Error("PDFファイルを選択してください");
      }

      const url = URL.createObjectURL(file);
      setPdfUrl(url);
      setRightPdfUrl(url);
      setFileName(file.name);

      // 疑似：自動対応表生成進捗表示
      setIsGenerating(true);
      setProgress(0);

      let p = 0;
      const timer = setInterval(() => {
        p += 10;
        setProgress(p);
        if (p >= 100) {
          clearInterval(timer);
          setIsGenerating(false);
        }
      }, 200);

    } catch (e) {
      console.error("PDF LOAD ERROR:", e);
      setError(e?.message || "PDF読み込みエラー");
    }
  };

  // ===== 条文ジャンプ =====
  const handleJump = () => {
    if (!pdfUrl) return;

    const page = Number(jumpPage);

    if (!page || page <= 0) {
      setError("正しいページ番号を入力してください");
      return;
    }

    setError(null);

    // iframe 再描画を強制
    const newUrl = `${pdfUrl}#page=${page}`;
    setRightPdfUrl(null);

    setTimeout(() => {
      setRightPdfUrl(newUrl);
    }, 50);
  };

  return (
    <div style={{ height: "100vh", display: "flex", flexDirection: "column" }}>

      {/* ===== 上部操作バー ===== */}
      <div style={{ padding: 10, borderBottom: "1px solid #ccc" }}>

        <input
          type="file"
          accept="application/pdf"
          onChange={(e) => handleFile(e.target.files?.[0])}
        />

        {fileName && (
          <span style={{ marginLeft: 12 }}>
            読込中: {fileName}
          </span>
        )}

        <span style={{ marginLeft: 20 }}>
          ページジャンプ:
        </span>

        <input
          style={{ width: 80, marginLeft: 6 }}
          value={jumpPage}
          onChange={(e) => setJumpPage(e.target.value)}
          placeholder="例: 41"
        />

        <button
          style={{ marginLeft: 6 }}
          onClick={handleJump}
        >
          ジャンプ
        </button>

      </div>

      {/* ===== 進捗表示 ===== */}
      {isGenerating && (
        <div style={{ padding: 8, background: "#f5f5f5" }}>
          条番号対応表 生成中… {progress}%
          <div style={{ height: 6, background: "#ddd", marginTop: 4 }}>
            <div
              style={{
                width: `${progress}%`,
                height: "100%",
                background: "#4caf50"
              }}
            />
          </div>
        </div>
      )}

      {/* ===== 本体 ===== */}
      <div style={{ flex: 1, display: "flex" }}>

        {/* ===== 左：全文 ===== */}
        <div style={{ width: "50%", borderRight: "1px solid #ccc" }}>
          {pdfUrl ? (
            <iframe
              title="full"
              src={pdfUrl}
              width="100%"
              height="100%"
            />
          ) : (
            <div style={{ padding: 20 }}>PDFを選択してください</div>
          )}
        </div>

        {/* ===== 右：ジャンプ先 ===== */}
        <div style={{ width: "50%" }}>
          {rightPdfUrl ? (
            <iframe
              title="jump"
              src={rightPdfUrl}
              width="100%"
              height="100%"
            />
          ) : (
            <div style={{ padding: 20 }}>ジャンプ待機中</div>
          )}
        </div>

      </div>

      {error && (
        <div style={{ color: "red", padding: 8 }}>
          {error}
        </div>
      )
