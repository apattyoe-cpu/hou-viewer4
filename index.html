<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>法律 条番号対応 ハイブリッド生成ツール（実抽出版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- pdf.js CDN（安定版固定） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: #f3f4f6;
      padding: 20px;
    }

    h1 { margin-top: 0; }

    .card {
      background: white;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border-bottom: 1px solid #eee;
      padding: 8px;
    }

    input {
      padding: 6px;
      width: 120px;
    }

    button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: #2563eb;
      color: white;
      cursor: pointer;
      margin-right: 6px;
    }

    .danger { background: #dc2626; }
    .ok { background: #16a34a; }

    .progress {
      background: #fff7cc;
      padding: 8px;
      border-radius: 6px;
      margin-top: 10px;
    }

  </style>
</head>

<body>

<h1>条番号 → ページ ハイブリッド生成ツール（実抽出版）</h1>

<div class="card">
  <h3>① PDF読み込み（条文候補を自動抽出）</h3>
  <input type="file" id="pdfInput" accept="application/pdf" />
  <div id="progress" class="progress" style="display:none">解析中… <span id="progressNum">0</span>%</div>
</div>

<div class="card">
  <h3>② 自動抽出候補（修正OK）</h3>
  <table>
    <thead>
      <tr>
        <th>条番号</th>
        <th>ページ</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="candidateTable"></tbody>
  </table>
</div>

<div class="card">
  <h3>③ 確定対応表</h3>
  <table>
    <thead>
      <tr>
        <th>条番号</th>
        <th>ページ</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="finalTable"></tbody>
  </table>
</div>

<div class="card">
  <button onclick="downloadJson()">JSON保存</button>
</div>

<script>

let candidates = {};
let finalMap = {};

const candidateTable = document.getElementById("candidateTable");
const finalTable = document.getElementById("finalTable");

// ===== PDF解析（実処理） =====
document.getElementById("pdfInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  const arrayBuffer = await file.arrayBuffer();
  await extractArticles(arrayBuffer);
});

async function extractArticles(buffer) {
  const progressBox = document.getElementById("progress");
  const progressNum = document.getElementById("progressNum");

  progressBox.style.display = "block";
  candidates = {};

  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
  const total = pdf.numPages;

  for (let pageNum = 1; pageNum <= total; pageNum++) {

    const page = await pdf.getPage(pageNum);
    const textContent = await page.getTextContent();

    const text = textContent.items.map(i => i.str).join(" ");

    // 条文検出（第○条）
    const matches = text.match(/第\s*([0-9一二三四五六七八九十百千]+)\s*条/g);

    if (matches) {
      matches.forEach(m => {
        const num = m.replace(/[^0-9]/g, "");
        if (num && !candidates[num]) {
          candidates[num] = pageNum;
        }
      });
    }

    const percent = Math.floor((pageNum / total) * 100);
    progressNum.textContent = percent;
  }

  progressBox.style.display = "none";
  renderCandidateTable();
}

// ===== 候補表 =====
function renderCandidateTable() {
  candidateTable.innerHTML = "";

  Object.keys(candidates).forEach(key => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${key}</td>
      <td><input value="${candidates[key]}" onchange="updateCandidate('${key}', this.value)" /></td>
      <td><button class="ok" onclick="approve('${key}')">確定</button></td>
    `;

    candidateTable.appendChild(tr);
  });
}

function updateCandidate(key, val) {
  candidates[key] = Number(val);
}

function approve(key) {
  finalMap[key] = candidates[key];
  delete candidates[key];
  renderCandidateTable();
  renderFinalTable();
}

// ===== 確定表 =====
function renderFinalTable() {
  finalTable.innerHTML = "";

  Object.keys(finalMap)
    .sort((a,b)=>Number(a)-Number(b))
    .forEach(key => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${key}</td>
        <td>${finalMap[key]}</td>
        <td><button class="danger" onclick="removeFinal('${key}')">削除</button></td>
      `;

      finalTable.appendChild(tr);
    });
}

function removeFinal(key) {
  delete finalMap[key];
  renderFinalTable();
}

// ===== JSON保存 =====
function downloadJson() {
  const blob = new Blob([JSON.stringify(finalMap, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "law_article_map.json";
  a.click();
}

</script>

</body>
</html>
