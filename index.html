<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>法令 条文ビューア（進捗可視化版 v2）</title>

  <style>
    body { margin:0; font-family:system-ui, sans-serif; background:#f3f4f6; }
    .app { display:flex; height:100vh; }
    .pane { display:flex; flex-direction:column; background:white; }
    .left { width:50%; border-right:1px solid #ddd; }
    .right { flex:1; }
    .header { padding:12px; border-bottom:1px solid #ddd; font-weight:bold; }
    .toolbar { padding:10px; border-bottom:1px solid #ddd; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    iframe { width:100%; height:100%; border:none; }
    input { padding:6px; font-size:16px; }
    button { padding:6px 14px; font-size:16px; cursor:pointer; }
    .error { color:red; font-size:14px; }
    .ok { color:green; font-size:14px; }
    .progressWrap { width:300px; height:16px; background:#ddd; border-radius:8px; overflow:hidden; }
    .progressBar { height:100%; width:0%; background:#4caf50; transition:width 0.2s; }
    .logBox { font-size:12px; background:#111; color:#0f0; padding:6px; height:80px; overflow:auto; }
  </style>
</head>

<body>
<div class="app">

  <div class="pane left">
    <div class="header">全文表示</div>
    <iframe id="leftViewer"></iframe>
  </div>

  <div class="pane right">
    <div class="header">条文ジャンプ表示</div>

    <div class="toolbar">
      <input type="file" accept="application/pdf" id="fileInput" />

      <button onclick="buildMapping()">条→ページ自動生成</button>

      <label>条番号:</label>
      <input type="number" id="articleInput" placeholder="例: 42" />

      <button onclick="jumpArticle()">ジャンプ</button>

      <span id="status"></span>
    </div>

    <div style="padding:8px">
      <div class="progressWrap">
        <div id="progressBar" class="progressBar"></div>
      </div>
      <div id="progressText" style="font-size:12px"></div>
      <div id="logBox" class="logBox"></div>
    </div>

    <iframe id="rightViewer"></iframe>
  </div>

</div>

<script type="module">
import * as pdfjsLib from "https://esm.sh/pdfjs-dist@3.11.174/build/pdf.mjs";

pdfjsLib.GlobalWorkerOptions.workerSrc = "https://esm.sh/pdfjs-dist@3.11.174/build/pdf.worker.mjs";

let pdfUrl = null;
let pdfDoc = null;
let articleToPage = {};

const fileInput = document.getElementById("fileInput");
const leftViewer = document.getElementById("leftViewer");
const rightViewer = document.getElementById("rightViewer");
const articleInput = document.getElementById("articleInput");
const statusSpan = document.getElementById("status");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const logBox = document.getElementById("logBox");

function log(msg){
  logBox.innerHTML += msg + "<br>";
  logBox.scrollTop = logBox.scrollHeight;
}

fileInput.addEventListener("change", async () => {
  const file = fileInput.files[0];
  if (!file) return;

  if (file.type !== "application/pdf") {
    status("PDFを選択してください", true);
    return;
  }

  pdfUrl = URL.createObjectURL(file);
  leftViewer.src = pdfUrl;
  rightViewer.src = pdfUrl + "#page=1";

  log("PDF読み込み開始");

  const buffer = await file.arrayBuffer();
  pdfDoc = await pdfjsLib.getDocument({ data: buffer }).promise;

  log("PDF解析準備完了 ページ数=" + pdfDoc.numPages);
  status("PDF読み込み完了", false);
});

async function buildMapping() {
  if (!pdfDoc) {
    status("先にPDFを読み込んでください", true);
    return;
  }

  articleToPage = {};
  const total = pdfDoc.numPages;
  const articleRegex = /第\s*(\d+)\s*条/g;

  log("条文解析開始");

  for (let p = 1; p <= total; p++) {

    const page = await pdfDoc.getPage(p);
    const text = await page.getTextContent();
    const pageText = text.items.map(i => i.str).join("");

    let match;
    while ((match = articleRegex.exec(pageText)) !== null) {
      const article = Number(match[1]);
      if (!articleToPage[article]) {
        articleToPage[article] = p;
        log(`検出 第${article}条 → p${p}`);
      }
    }

    const percent = Math.floor((p / total) * 100);
    progressBar.style.width = percent + "%";
    progressText.innerText = `${p} / ${total} ページ解析 (${percent}%)`;

    await new Promise(r => setTimeout(r, 5));
  }

  log("解析完了 条数=" + Object.keys(articleToPage).length);
  status("対応生成完了", false);
}

function jumpArticle() {
  if (!pdfUrl) return;

  const article = Number(articleInput.value);
  const page = articleToPage[article];

  if (!page) {
    status("条番号未検出", true);
    return;
  }

  rightViewer.src = "";
  setTimeout(() => {
    rightViewer.src = pdfUrl + "#page=" + page;
  }, 50);

  status(`第${article}条 → p.${page}`, false);
}

function status(msg, isError) {
  statusSpan.textContent = msg;
  statusSpan.className = isError ? "error" : "ok";
}

</script>

</body>
</html>
