// 国保法 条文ビューア（左：全文固定 / 右：条文ジャンプ対応 / 複数法律拡張前提）

import React, { useState, useEffect } from "react";

// ===== 設計方針 =====
// ・pdf.js 不使用（環境依存回避）
// ・ブラウザ標準PDF Viewer 使用
// ・Safari / iPad 互換のため iframe + embed フォールバック
// ・#page= でページジャンプ制御

export default function KokuhouLawViewer() {

  const [pdfUrl, setPdfUrl] = useState(null);
  const [fileName, setFileName] = useState("");
  const [error, setError] = useState(null);
  const [jumpPage, setJumpPage] = useState("");
  const [rightPdfUrl, setRightPdfUrl] = useState(null);
  const [viewerKey, setViewerKey] = useState(0); // ← 再描画強制

  // ===== PDF読み込み =====
  const handleFile = async (file) => {
    if (!file) return;

    try {
      setError(null);

      if (file.type !== "application/pdf") {
        throw new Error("PDFファイルを選択してください");
      }

      const url = URL.createObjectURL(file);

      setPdfUrl(url);
      setRightPdfUrl(url);
      setFileName(file.name);
      setViewerKey(k => k + 1); // ← Viewer強制更新

    } catch (e) {
      console.error("PDF LOAD ERROR:", e);
      setError(e?.message || "PDF読み込みエラー");
    }
  };

  // ===== 条文ジャンプ =====
  const handleJump = () => {
    if (!pdfUrl) return;

    const page = Number(jumpPage);

    if (!page || page <= 0) {
      setError("正しいページ番号を入力してください");
      return;
    }

    setError(null);

    const jumpUrl = `${pdfUrl}#page=${page}`;
    setRightPdfUrl(jumpUrl);
    setViewerKey(k => k + 1); // ← Safari対策
  };

  // ===== URLクリーンアップ =====
  useEffect(() => {
    return () => {
      if (pdfUrl) URL.revokeObjectURL(pdfUrl);
    };
  }, [pdfUrl]);

  return (
    <div className="flex h-screen bg-gray-100">

      {/* ===== 左ペイン：全文固定 ===== */}
      <div className="w-1/2 bg-white border-r flex flex-col">

        <div className="p-3 border-b font-bold text-lg">
          全文表示
        </div>

        <div className="p-3 border-b flex gap-2 items-center">
          <input
            type="file"
            accept="application/pdf"
            onChange={(e) => handleFile(e.target.files[0])}
          />
          {error && <span className="text-red-500 text-sm">{error}</span>}
        </div>

        <div className="flex-1 bg-gray-300">
          {pdfUrl ? (
            <>
              {/* iframe（通常ブラウザ用） */}
              <iframe
                key={`left-${viewerKey}`}
                src={pdfUrl}
                title="PDF Left Viewer"
                className="w-full h-full"
              />

              {/* embed（iPad / Safari フォールバック） */}
              <embed
                src={pdfUrl}
                type="application/pdf"
                className="hidden"
              />
            </>
          ) : (
            <div className="h-full flex items-center justify-center text-gray-600">
              PDFを選択してください
            </div>
          )}
        </div>

      </div>

      {/* ===== 右ペイン：ジャンプ表示 ===== */}
      <div className="w-1/2 flex flex-col">

        <div className="p-3 bg-white border-b flex gap-2 items-center">
          <input
            type="number"
            placeholder="ページ番号"
            value={jumpPage}
            onChange={(e) => setJumpPage(e.target.value)}
            className="border px-2 py-1 w-32"
          />

          <button
            onClick={handleJump}
            className="bg-blue-600 text-white px-3 py-1 rounded"
          >
            ジャンプ
          </button>
        </div>

        <div className="flex-1 bg-gray-300">
          {rightPdfUrl ? (
            <>
              {/* iframe */}
              <iframe
                key={`right-${viewerKey}`}
                src={rightPdfUrl}
                title="PDF Right Viewer"
                className="w-full h-full"
              />

              {/* embed fallback */}
              <embed
                src={rightPdfUrl}
                type="application/pdf"
                className="hidden"
              />
            </>
          ) : (
            <div className="h-full flex items-center justify-center text-gray-600">
              PDFを読み込むと表示されます
            </div>
          )}
        </div>

      </div>

    </div>
  );
}


// ===== テストケース =====
// 1. PDF選択 → 左右にPDF表示される
// 2. ページ番号入力 → 右のみページジャンプ
// 3. Safari / iPad → 表示される
// 4. 大容量PDF → フリーズしない
// 5. 連続ジャンプ → 正しく更新される
// 6. PDF再読み込み → 古いURLが破棄される
