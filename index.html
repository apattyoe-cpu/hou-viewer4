<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>法令 条文ビューア（自動条対応生成版）</title>

  <style>
    body { margin:0; font-family:system-ui, sans-serif; background:#f3f4f6; }
    .app { display:flex; height:100vh; }
    .pane { display:flex; flex-direction:column; background:white; }
    .left { width:50%; border-right:1px solid #ddd; }
    .right { flex:1; }
    .header { padding:12px; border-bottom:1px solid #ddd; font-weight:bold; }
    .toolbar { padding:10px; border-bottom:1px solid #ddd; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    iframe { width:100%; height:100%; border:none; }
    input { padding:6px; font-size:16px; }
    button { padding:6px 14px; font-size:16px; cursor:pointer; }
    .error { color:red; font-size:14px; }
    .ok { color:green; font-size:14px; }
  </style>
</head>

<body>
<div class="app">

  <div class="pane left">
    <div class="header">全文表示</div>
    <iframe id="leftViewer"></iframe>
  </div>

  <div class="pane right">
    <div class="header">条文ジャンプ表示</div>

    <div class="toolbar">
      <input type="file" accept="application/pdf" id="fileInput" />

      <button onclick="buildMapping()">条→ページ自動生成</button>

      <label>条番号:</label>
      <input type="number" id="articleInput" placeholder="例: 42" />

      <button onclick="jumpArticle()">ジャンプ</button>

      <span id="status"></span>
    </div>

    <iframe id="rightViewer"></iframe>
  </div>

</div>

<script type="module">
import * as pdfjsLib from "https://esm.sh/pdfjs-dist@3.11.174/build/pdf.mjs";

pdfjsLib.GlobalWorkerOptions.workerSrc = "https://esm.sh/pdfjs-dist@3.11.174/build/pdf.worker.mjs";

let pdfUrl = null;
let pdfDoc = null;
let articleToPage = {};

const fileInput = document.getElementById("fileInput");
const leftViewer = document.getElementById("leftViewer");
const rightViewer = document.getElementById("rightViewer");
const articleInput = document.getElementById("articleInput");
const statusSpan = document.getElementById("status");

fileInput.addEventListener("change", async () => {
  const file = fileInput.files[0];
  if (!file) return;

  if (file.type !== "application/pdf") {
    status("PDFを選択してください", true);
    return;
  }

  pdfUrl = URL.createObjectURL(file);
  leftViewer.src = pdfUrl;
  rightViewer.src = pdfUrl + "#page=1";

  const buffer = await file.arrayBuffer();
  pdfDoc = await pdfjsLib.getDocument({ data: buffer }).promise;

  status("PDF読み込み完了", false);
});

async function buildMapping() {
  if (!pdfDoc) {
    status("先にPDFを読み込んでください", true);
    return;
  }

  status("条文解析中…", false);
  articleToPage = {};

  const articleRegex = /第\s*(\d+)\s*条/g;

  for (let p = 1; p <= pdfDoc.numPages; p++) {
    const page = await pdfDoc.getPage(p);
    const text = await page.getTextContent();

    const pageText = text.items.map(i => i.str).join("");

    let match;
    while ((match = articleRegex.exec(pageText)) !== null) {
      const article = Number(match[1]);
      if (!articleToPage[article]) {
        articleToPage[article] = p;
      }
    }
  }

  status(`対応生成完了 (${Object.keys(articleToPage).length}条検出)`, false);
}

function jumpArticle() {
  if (!pdfUrl) return;

  const article = Number(articleInput.value);
  const page = articleToPage[article];

  if (!page) {
    status("条番号未検出（先に自動生成してください）", true);
    return;
  }

  rightViewer.src = "";
  setTimeout(() => {
    rightViewer.src = pdfUrl + "#page=" + page;
  }, 50);

  status(`第${article}条 → p.${page}`, false);
}

function status(msg, isError) {
  statusSpan.textContent = msg;
  statusSpan.className = isError ? "error" : "ok";
}

</script>

</body>
</html>

<!--
テスト

1 PDF読込
2 自動生成クリック
3 条番号ジャンプ
4 iPad Safari
5 GitHub Pages

-->
